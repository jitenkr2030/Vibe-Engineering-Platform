# Kubernetes ConfigMap for Vibe Platform
# Contains non-sensitive configuration for both frontend and backend services

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: vibe-config
  namespace: vibe-production
  labels:
    app.kubernetes.io/name: vibe
    app.kubernetes.io/component: configuration
data:
  # Application Configuration
  NODE_ENV: "production"
  API_PREFIX: "/api/v1"

  # Frontend Configuration
  NEXT_PUBLIC_APP_NAME: "Vibe Engineering Platform"
  NEXT_PUBLIC_APP_DESCRIPTION: "AI-powered software engineering platform"
  NEXT_PUBLIC_FEATURES_ENABLED: "true"

  # Backend Configuration
  LOG_LEVEL: "info"
  LOG_FORMAT: "json"
  REQUEST_TIMEOUT: "30000"
  RATE_LIMIT_WINDOW_MS: "900000"
  RATE_LIMIT_MAX_REQUESTS: "100"

  # File Upload Configuration
  MAX_FILE_SIZE: "10485760"
  MAX_FILES_PER_UPLOAD: "10"
  ALLOWED_FILE_TYPES: ".js,.ts,.json,.md,.txt,.yaml,.yml,.html,.css,.png,.jpg,.svg"

  # AI Service Configuration
  AI_MAX_TOKENS: "4096"
  AI_TEMPERATURE: "0.7"
  AI_TIMEOUT_MS: "60000"
  AI_MAX_CONCURRENT_REQUESTS: "10"

  # Database Pool Configuration
  DB_POOL_MIN: "2"
  DB_POOL_MAX: "10"
  DB_IDLE_TIMEOUT_MS: "30000"

  # Redis Configuration
  REDIS_KEY_PREFIX: "vibe:"
  REDIS_TTL_SECONDS: "3600"

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: vibe-nginx-config
  namespace: vibe-production
  labels:
    app.kubernetes.io/name: vibe
    app.kubernetes.io/component: nginx
data:
  nginx.conf: |
    worker_processes auto;
    error_log /var/log/nginx/error.log warn;
    pid /tmp/nginx.pid;

    events {
        worker_connections 1024;
        use epoll;
        multi_accept on;
    }

    http {
        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        # Logging format
        log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_x_forwarded_for"';

        access_log /var/log/nginx/access.log main;

        # Performance optimization
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;

        # Gzip compression
        gzip on;
        gzip_vary on;
        gzip_proxied any;
        gzip_comp_level 6;
        gzip_types text/plain text/css text/xml application/json application/javascript application/rss+xml image/svg+xml;

        # Buffer sizes
        client_body_buffer_size 128k;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;

        # Timeouts
        client_body_timeout 60s;
        client_header_timeout 60s;
        keepalive_timeout 65s;
        send_timeout 60s;

        # Security headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Nginx-Proxy true;

        # Cache headers for static assets
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        # Health check endpoint
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # API routes
        location /api/ {
            proxy_pass http://vibe-backend:3001/api/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # Next.js static files
        location /_next/static/ {
            proxy_pass http://vibe-frontend:3000/_next/static/;
            proxy_cache_valid 200 60m;
            expires 1y;
        }

        # Next.js public files
        location /_next/public/ {
            proxy_pass http://vibe-frontend:3000/_next/public/;
            proxy_cache_valid 200 60m;
            expires 1y;
        }

        # Root location
        location / {
            proxy_pass http://vibe-frontend:3000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
